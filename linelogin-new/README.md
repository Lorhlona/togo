# 予約管理システム実装の申し送り

## 実装済みの内容

### 1. 基本的な予約システムの完成 🎉
- 時間枠の生成と管理が正常に動作
- 日本時間での正確な時間管理を実現
- 予約の追加/編集/削除機能が利用可能
- 初診/再診の区別と適切な時間枠設定

### 2. カレンダー表示の改善
- yoyaの実装を参考に、より直感的な状態表示を実装
- 予約状況の表示を統一（○△×ー）
  - 初診枠（30分）: ○（空き）、×（予約済み）、ー（休診）
  - 再診枠（15分）: ○（空き）、△（1人予約）、×（2人予約）、ー（休診）
- カレンダーの日付クリックで開院日/休診日を直接設定可能に改善

### 3. 時間枠管理の実装
- 15分/30分枠の柔軟な切り替え機能
- 初診/再診の明確な区別
- ブロック機能の実装
- デフォルトスケジュール設定の連携
- 時間枠のデフォルトを休診に変更
- 日本時間（JST）での正確な時間管理を実装

### 4. 予約管理機能の強化
- 予約の追加/編集/削除機能
- 予約状況の視覚的表示
- エラーハンドリングの実装
- 一時的な患者情報の管理

### 5. APIエンドポイントの整備
- `/api/timeslots`: 時間枠の管理
- `/api/timeslots/combine`: 時間枠の結合機能
- `/api/reservations`: 予約の管理
- `/api/default-schedule`: デフォルト設定の管理

## 日本時間（JST）処理における重要な注意点

### 1. データベース保存時の注意点
- データベースにはUTCで保存
- JST→UTC変換時は9時間を引く（UTC = JST - 9）
- 日付が変わる場合（0時-9時）の特別処理が必要

### 2. 時間枠生成時の注意点
- 診療時間は日本時間で定義（9:00-20:00など）
- 生成時はJST→UTC変換が必要
- 日付をまたがないように日付範囲の設定が重要
  - 日本時間の0時 = UTC前日15時
  - 日本時間の24時 = UTC15時

### 3. フロントエンド表示時の注意点
- UTC→JST変換が必要（JST = UTC + 9）
- 表示用の時間フォーマットは日本時間で行う
- クライアント側での時間表示を尊重する

## 次のAIへの引き継ぎ事項

### 1. 実装予定の機能
- 予約制限の詳細設定
  - 特定の時間帯の予約制限
  - 患者ごとの予約制限
- 一括操作機能の追加
  - 複数日の一括設定
  - 定期的な予約パターンの設定

### 2. 改善が必要な点
- TypeScriptの型定義の強化
- エラーメッセージの多言語対応
- パフォーマンスの最適化
  - データベースクエリの効率化
  - キャッシュの活用

### 3. 注意点
- Prismaスキーマの変更時は慎重に対応
- 予約データの整合性を常に確認
- 時間枠の管理は日本時間（JST）で処理

### 4. デプロイ関連
- Vercelでデプロイ済み
- NEONデータベースを使用
- GitHub連携でデプロイを自動化

## コードの主な場所
- `components/admin/calendar-view.tsx`: カレンダー表示
- `components/admin/day-view.tsx`: 日別予約管理
- `app/api/timeslots/route.ts`: 時間枠API
- `app/api/timeslots/combine/route.ts`: 時間枠結合API
- `app/api/reservations/route.ts`: 予約API

## 技術スタック
- Next.js
- Prisma (PostgreSQL)
- TypeScript
- Tailwind CSS
- date-fns (^4.1.0)
- date-fns-tz (^3.2.0) - 日本時間対応用

## 環境設定
- データベース: NEON (PostgreSQL)
- デプロイ: Vercel
- 認証: LINE Login

## デプロイ手順

1. Prismaスキーマの変更を反映
```bash
cd linelogin
npx prisma generate  # 型定義の更新
npx prisma db push   # データベースの更新
```

2. 依存関係の更新
```bash
cd linelogin
npm install  # 新しい依存関係をインストール
```

3. Vercelへのデプロイ
```bash
git add .
git commit -m "セーブポイント：基本的な予約システムの完成"
git push  # GitHub連携により自動デプロイ
```

## 運用上の注意点
- 予約データの整合性を保つため、時間枠の削除は慎重に
- 予約状況の変更は必ずデータベースの状態を確認
- 日本時間での処理を徹底
- 時間枠の結合は予約がない場合のみ可能

これらの実装と注意点を踏まえて、さらなる機能追加や改善を行ってください。


QRログインシステム完成